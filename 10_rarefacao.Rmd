# Rarefa√ß√£o {#cap10}

### Pr√©-requisitos do cap√≠tulo {-}

```{r}
# Pacotes
library(iNEXT)
library(devtools)
library(ecodados)
library(ggplot2)
library(vegan)
library(nlme)
library(dplyr)
library(piecewiseSEM)

## Dados necess√°rios
data("mite")
data("mite.xy")
coord <- mite.xy
colnames(coord) <- c("long", "lat")
data("mite.env")
agua <- mite.env[,2]
dados_rarefacao <- ecodados::rarefacao_morcegos
rarefacao_repteis <- ecodados::rarefacao_repteis
rarefacao_anuros <- ecodados::rarefacao_anuros
dados_amostras <-   ecodados::morcegos_rarefacao_amostras
```

## Aspectos te√≥ricos

Uma das grandes dificuldades na compara√ß√£o da riqueza de esp√©cies entre comunidades √© decorrente da diferen√ßa no esfor√ßo amostral (e.g. diferen√ßa no n√∫mero de indiv√≠duos, discrep√¢ncia na quantidade de unidades amostrais ou √°rea amostrada) que inevitavelmente influenciar√° no n√∫mero de esp√©cies observadas [@gotelli2013; @roswell2021]. O m√©todo de rarefa√ß√£o nos permite comparar o n√∫mero de esp√©cies entre comunidades quando o tamanho da amostra (e.g. n√∫mero de unidades amostrais), o esfor√ßo amostral (e.g. tempo de amostragem) ou a abund√¢ncia de indiv√≠duos n√£o s√£o iguais. A rarefa√ß√£o calcula o n√∫mero esperado de esp√©cies em cada comunidade tendo como base comparativa um valor em que todas as amostras atinjam um tamanho padr√£o. Gotelli & Colwell [-@gotelli2001] descrevem dois tipos de curvas de rarefa√ß√£o: i) baseada em indiv√≠duos (*individual-based*) - as compara√ß√µes s√£o feitas considerando a abund√¢ncia da comunidade padronizada pelo menor n√∫mero de indiv√≠duos; e ii) baseada na amostra (*sampled-based*) - as compara√ß√µes s√£o padronizadas pela comunidade com menor n√∫mero de amostragens.

O m√©todo foi formulado considerando a seguinte pergunta: Se considerarmos *n* indiv√≠duos ou amostras (*n* \< N) para cada comunidade, quantas esp√©cies registrar√≠amos nas comunidades considerando o mesmo n√∫mero de indiv√≠duos ou amostras?

> #### Gotelli & Colwell [-@gotelli2001] descrevem este m√©todo e discutem em detalhes as restri√ß√µes sobre seu uso na ecologia:
>
> -   As amostras a serem comparadas devem ser consistentes do ponto de vista taxon√¥mico, ou seja, todos os indiv√≠duos devem pertencer ao mesmo grupo taxon√¥mico;
> -   As compara√ß√µes devem ser realizadas somente entre amostras com as mesmas t√©cnicas de coleta. Por exemplo, n√£o √© recomendado comparar amostras onde a riqueza de esp√©cies de anuros de uma amostra foi estimada utilizando armadilhas de intercepta√ß√£o e queda e a outra foi estimada por vocaliza√ß√µes em s√≠tios de reprodu√ß√£o;
> -   Os tipos de h√°bitat onde as amostras s√£o obtidas devem ser semelhantes;
> -   √â um m√©todo para estimar a riqueza de esp√©cies em uma amostra menor -- n√£o pode ser usado para extrapolar a riqueza para amostras maiores.

::: {.alert .alert-info}
<strong> üìù Importante: </strong> Esta √∫ltima restri√ß√£o foi superada por Colwell et al. [-@colwell2012] e Chao & Jost [-@chao2012] que desenvolveram uma nova abordagem onde os dados podem ser interpolados (rarefeito) para amostras menores e extrapolados para amostras maiores. Al√©m disso, Chao & Jost [-@chao2012] prop√µem a curva de rarefa√ß√£o *coverage-based* que padroniza as amostras pela cobertura ou totalidade (*completeness*) da amostra ao inv√©s do tamanho. As rarefa√ß√µes tradicionais apresentam limita√ß√µes matem√°ticas que s√£o superadas por essa nova abordagem [@chao2012].
:::

## Curva de rarefa√ß√£o baseada no indiv√≠duo (*individual-based*)

#### Exemplo pr√°tico 1 - Morcegos

**Explica√ß√£o dos dados**

Usaremos os dados de esp√©cies de morcegos amostradas em tr√™s fragmentos florestais [@breviglieri2008]: i) Mata Ciliar do C√≥rrego Talhadinho com 12 hectares; ii) Mata Ciliar do C√≥rrego dos Tenentes com 10 hectares; e iii) Fazenda Experimental de Pindorama com 128 hectares.

**Pergunta:**

> A riqueza de esp√©cies de morcegos √© maior na Fazenda Experimental do que nos fragmentos florestais menores?

**Predi√ß√µes**

> O n√∫mero de esp√©cies ser√° maior em fragmentos florestais maiores.

**Vari√°veis**

-   Vari√°veis resposta e preditoras

    -   Matriz ou dataframe com as abund√¢ncias das esp√©cies de morcegos (vari√°vel resposta) registradas nos tr√™s fragmentos florestais (vari√°vel preditora).

**Checklist**

-   Verificar se a sua matriz ou dataframe est√£o com as esp√©cies nas linhas e os fragmentos florestais nas colunas

**An√°lise**

Vamos olhar os dados usando a fun√ß√£o `head`

```{r}
head(dados_rarefacao)
```

Usaremos as fun√ß√µes do pacote iNEXT (iNterpolation e EXTrapolation) para o c√°lculo da rarefa√ß√£o. Esta fun√ß√£o permite estimar a riqueza de esp√©cies utilizando a fam√≠lia *Hill-numbers* (Hill 1973; explica√ß√£o dos conceitos da fam√≠lia *Hill-numbers* est√° detalhada no \@[cap12]). O argumento q refere-se a fam√≠lia Hill-numbers onde: 0 = riqueza de esp√©cies; 1 = diversidade de Shannon; e 2 = diversidade de Simpson.

```{r}
# Datatype refere-se ao tipo de dados que voc√™ vai analisar (e.g. abund√¢ncia, 
# incid√™ncia).
# Endpoint refere-se ao valor m√°ximo que voc√™ determina para a extrapola√ß√£o.
resultados_morcegos <- iNEXT(dados_rarefacao, q = 0, 
                             datatype = "abundance", endpoint = 800)
```

Vamos visualizar os resultados.

```{r}
# type define o tipo de curva de rarefa√ß√£o: 
# 1 = curva de rarefa√ß√£o baseada no indiv√≠duo ou amostra; 
# 2 = curva de representatividade da amostra; e 
# 3 = curva de rarefa√ß√£o baseada na representatividade (coverage-based).
ggiNEXT(resultados_morcegos, type = 1) +
  labs(x = "N√∫mero de indiv√≠duos", y = " Riqueza de esp√©cies") +
  scale_linetype_discrete(labels = c("Interpolado", "Extrapolado")) +
  scale_colour_manual(values = c("darkorange", "darkorchid", "cyan4")) +
  scale_fill_manual(values = c("darkorange", "darkorchid", "cyan4"))
```

**Interpreta√ß√£o dos resultados**

Foram registrados 166 indiv√≠duos na MC_Tenentes, 413 na MC_Talhadinho e 223 na FF_Experimental. Lembrando, voc√™ n√£o pode comparar a riqueza de esp√©cies observada diretamente: 15 esp√©cies na MC_Tenentes, 19 esp√©cies na MC_Talhadinho, e 17 esp√©cies no FF_Experimental. A compara√ß√£o da riqueza de esp√©cies entre as comunidades deve ser feita com base na riqueza de esp√©cies rarefeita, que √© calculada com base no n√∫mero de indiv√≠duos da comunidade com menor abund√¢ncia (166 indiv√≠duos). Olhando o gr√°fico √© poss√≠vel perceber que a riqueza de esp√©cies de morcegos rarefeita n√£o √© diferente entre os tr√™s fragmentos florestais quando corrigimos o problema da diferen√ßa na abund√¢ncia pela rarefa√ß√£o. A interpreta√ß√£o √© feita com base no intervalo de confian√ßa de 95%. As curvas ser√£o diferentes quando os intervalos de confian√ßa n√£o se sobreporem [@chao2014]. Percebam que esta abordagem, al√©m da interpola√ß√£o (rarefa√ß√£o), tamb√©m realiza extrapola√ß√µes que podem ser usadas para estimar o n√∫mero de esp√©cies caso o esfor√ßo de coleta fosse maior. Este √© o assunto do nosso pr√≥ximo cap√≠tulo.

<p>

¬†

</p>

#### Exemplo pr√°tico 2 - Anuros e R√©pteis

**Explica√ß√£o dos dados**

Neste exemplo, iremos comparar o n√∫mero de esp√©cies de anuros e r√©pteis (serpentes e lagartos) usando informa√ß√µes dos indiv√≠duos depositados em cole√ß√µes cient√≠ficas e coletas de campo [@silva2017].

**Pergunta:**

> A riqueza de esp√©cies estimada para uma mesma regi√£o √© maior usando informa√ß√µes de cole√ß√µes cient√≠ficas do que informa√ß√µes de coletas de campo?

**Predi√ß√µes**

> O n√∫mero de esp√©cies ser√° maior em cole√ß√µes cient√≠ficas devido ao maior esfor√ßo amostral (i.e. maior varia√ß√£o temporal para depositar os indiv√≠duos e maior n√∫mero de pessoas contribuindo com coletas espor√°dicas).

**Vari√°veis**

-   Vari√°veis resposta e preditoras

    -   Matriz ou dataframe com as abund√¢ncias das esp√©cies de anuros e r√©pteis (vari√°vel resposta) registradas em cole√ß√µes cient√≠ficas e coletas de campo (vari√°vel preditora).

**Checklist**

-   Verificar se a sua matriz ou dataframe est√£o com as esp√©cies nas linhas e a fonte dos dados nas colunas.

**An√°lise**

Olhando os dados dos r√©pteis.

```{r}
head(rarefacao_repteis)
```

An√°lise usando o pacote iNEXT.

```{r}
# An√°lise
resultados_repteis <- iNEXT(rarefacao_repteis, q = 0,
                            datatype = "abundance", 
                            endpoint = 200)

# Visualizar os resultados.
ggiNEXT(resultados_repteis, type = 1) +
  labs(x = "N√∫mero de indiv√≠duos", y = " Riqueza de esp√©cies") +
  scale_linetype_discrete(labels = c("Interpolado", "Extrapolado")) +
  scale_colour_manual(values = c("darkorange", "cyan4")) +
  scale_fill_manual(values = c("darkorange", "cyan4"))
```

**Interpreta√ß√£o dos resultados - r√©pteis**

Foram registradas oito esp√©cies de r√©pteis nas coletas de campo (40 indiv√≠duos) e 28 esp√©cies nas cole√ß√µes cient√≠ficas (77 indiv√≠duos). Com base na rarefa√ß√£o, conclu√≠mos que a riqueza de esp√©cies de r√©pteis obtida nas cole√ß√µes cient√≠ficas (20,5) √© 2,9 vezes maior do que a obtida em coletas de campo (7,05).

Olhando os dados dos anuros

```{r}
head(rarefacao_anuros)
```

An√°lise e visualiza√ß√£o do gr√°fico.

```{r}
# An√°lise
resultados_anuros <- iNEXT(rarefacao_anuros, q = 0, 
                           datatype = "abundance", endpoint = 800)

# Visualizar os resultados.
ggiNEXT(resultados_anuros, type = 1) + 
  labs(x = "N√∫mero de indiv√≠duos", y = " Riqueza de esp√©cies") +
  scale_linetype_discrete(labels = c("Interpolado", "Extrapolado")) +
  scale_colour_manual(values = c("darkorange", "cyan4")) +
  scale_fill_manual(values = c("darkorange", "cyan4"))
```

**Interpreta√ß√£o dos resultados - anuros**

Foram registradas 21 esp√©cies de anuros nas coletas de campo (709 indiv√≠duos) e 12 esp√©cies nas cole√ß√µes cient√≠ficas (37 indiv√≠duos). Com base na rarefa√ß√£o, conclu√≠mos que n√£o h√° diferen√ßa entre a riqueza de esp√©cies de anuros obtida em coletas de campo e cole√ß√µes cient√≠ficas.

## Curva de rarefa√ß√£o baseada em amostras (*sample-based*)

#### Exemplo pr√°tico 3 - Morcegos

**Explica√ß√£o dos dados**

Usaremos os mesmos dados de esp√©cies de morcegos amostradas em tr√™s fragmentos florestais [@breviglieri2008]. Contudo, ao inv√©s de padronizarmos a riqueza de esp√©cies pela abund√¢ncia, iremos padronizar pelo n√∫mero de amostras.

**Vari√°veis**

-   Vari√°veis resposta e preditoras

    -   Lista de vetores. Cada vetor deve conter como primeira informa√ß√£o, o n√∫mero total de amostras (vari√°vel preditora), seguido da frequ√™ncia de ocorr√™ncia das esp√©cies (i.e. n√∫mero de amostras em que cada esp√©cie foi registrada - vari√°vel resposta).

**Checklist**

-   Verificar se a sua lista est√° com o n√∫mero total de amostras e a frequ√™ncia de ocorr√™ncia das esp√©cies.

**An√°lise**

Vamos olhar os dados.

```{r}
head(dados_amostras)
```

Vamos criar uma lista com as amostragens de cada comunidade e os comandos da an√°lise.

```{r}
# Usamos [,] para excluir os NAs. Lembrando que valores antes da 
# v√≠rgula representam as linhas e os posteriores representam as colunas.
lista_rarefacao <- list(Tenentes = dados_amostras[1:18,1],
                        Talhadinho = dados_amostras[,2],
                        Experimental = dados_amostras[1:16,3])

# An√°lise.
res_rarefacao_amostras <- iNEXT(lista_rarefacao, q = 0, 
                            datatype="incidence_freq")
```

Visualizar os resultados.

```{r}
# Gr√°fico
ggiNEXT(res_rarefacao_amostras , type = 1, color.var = "site") + 
  theme_bw(base_size = 18) + 
  theme(legend.position = "right") +
  labs(x = "N√∫mero de amostras", y = " Riqueza de esp√©cies") +
  scale_linetype_discrete(name = "M√©todo", 
                          labels = c("Interpolado", "Extrapolado")) +
  scale_colour_manual(values = c("darkorange", "darkorchid", "cyan4")) +
  scale_fill_manual(values = c("darkorange", "darkorchid", "cyan4"))
```

**Interpreta√ß√£o dos resultados**

Olhando o gr√°fico √© poss√≠vel perceber que a riqueza de esp√©cies de morcegos rarefeita n√£o √© diferente entre os tr√™s fragmentos florestais quando corrigimos o problema da diferen√ßa no n√∫mero de amostras.

## Curva de rarefa√ß√£o *coverage-based*

#### Exemplo pr√°tico 4 - Morcegos

**Explica√ß√£o dos dados**

Neste exemplo, usaremos os mesmos dados de esp√©cies de morcegos amostradas em tr√™s fragmentos florestais [@breviglieri2008].

**An√°lise**

Os comandos para a rarefa√ß√£o *coverage-based* s√£o id√™nticos aos utilizados para o c√°lculo das curvas de rarefa√ß√µes baseadas nas abund√¢ncias e amostras. Portanto, n√£o repetiremos as linhas de comando aqui e utilizaremos os resultados j√° calculados para a visualiza√ß√£o dos gr√°ficos. Para isso, digitamos `type` = 3 que representa a curva de rarefa√ß√£o *coverage-based*.

```{r}
# Visualizar os resultados da rarefa√ß√£o *coverage-based*. 
ggiNEXT(res_rarefacao_amostras, type = 3, color.var = "site") + 
  theme_bw(base_size = 18) + 
  theme(legend.position = "right") +
  labs(x = "Representatividade nas amostras", y = "Riqueza de esp√©cies") +
  scale_linetype_discrete(labels = c("Interpolado", "Extrapolado")) +
  scale_colour_manual(values = c("darkorange", "darkorchid", "cyan4")) +
  scale_fill_manual(values = c("darkorange", "darkorchid", "cyan4"))

```

**Interpreta√ß√£o dos resultados**

*Coverage* √© uma medida que determina a propor√ß√£o de amostras (*sampled-based*) ou do n√∫mero de indiv√≠duos (*abundance-based*) da comunidade que representa as esp√©cies presentes na amostra. Um valor de *coverage* = 0,85 representa a riqueza estimada com base em 85% das amostragens ou da abund√¢ncia da comunidade. No nosso exemplo, os valores de *coverage* foram acima de 0,93 indicando que precisamos de praticamente todas as amostras para estimar a riqueza observada em cada comunidade. Comparando as comunidades considerando o mesmo valor de *coverage,* 0,937 na comunidade Tenentes, identificamos que a riqueza de esp√©cies de morcegos estimada na comunidade Experimental √© menor do que a estimada para a comunidade de Talhadinho (n√£o h√° sobreposi√ß√£o do intervalo de confian√ßa). Percebam que usando a curva de rarefa√ß√£o *coverage-based*, a interpreta√ß√£o dos resultados foi diferente das observadas usando as curvas baseadas nos indiv√≠duos ou amostras. Veja Chao & Jost [-@chao2012] e Roswell et al. [-@roswell2021] para explica√ß√µes mais detalhadas sobre esta metodologia.

<p>

¬†

</p>

#### Exemplo pr√°tico 5 - Generalized Least Squares (GLS)

**Explica√ß√£o dos dados**

Neste exemplo, iremos refazer o exerc√≠cio do \@{cap8} onde usamos Generalized Least Squares (GLS) para testar a rela√ß√£o da riqueza de √°caros com a quantidade de √°gua no substrato. Contudo, ao inv√©s de considerar a riqueza de esp√©cies de √°caros observada como vari√°vel resposta, iremos utilizar a riqueza rarefeita para controlar o efeito da amostragem (i.e. diferentes abund√¢ncias entre as comunidades). Os dados que usaremos est√£o dispon√≠veis no pacote `vegan` e representam a composi√ß√£o de esp√©cies de √°caros amostradas em 70 amostras.

**Pergunta:**

> A riqueza rarefeita de esp√©cies de √°caros √© maior em comunidades localizadas em √°reas com substratos secos?

**Predi√ß√µes**

> O n√∫mero de esp√©cies rarefeita ser√° maior em substratos secos, uma vez que as limita√ß√µes fisiol√≥gicas impostas pela umidade limitam a ocorr√™ncia de v√°rias esp√©cies de √°caros.

**Vari√°veis**

-   Vari√°veis resposta e preditoras

    -   Matriz ou dataframe com as abund√¢ncias das esp√©cies de √°caros (vari√°vel resposta) registradas em 70 comunidades (vari√°vel preditora).

**Checklist**

-   Verificar se a sua matriz ou dataframe est√£o com as esp√©cies nas linhas e as comunidades nas colunas.

**An√°lise**

Vamos calcular a riqueza rarefeita com base na comunidade com menor abund√¢ncia.

```{r}
# Os dados est√£o com as comunidades nas colunas e as esp√©cies nas linhas. 
# Para as an√°lises teremos que transpor a planilha.
composicao_acaros <- t(mite)

# Verificar qual √© a menor abund√¢ncia registrada nas comunidades. 
min(colSums(composicao_acaros))

```


Vamos calcular a riqueza rarefeita de esp√©cies para todas as comunidades considerando a menor abund√¢ncia. 

Para padronizar e facilitar a extra√ß√£o dos resultados, definimos os argumentos `knots` (i.e. representa o intervalo igualmente espa√ßado que a fun√ß√£o ir√° utilizar para determinar a riqueza estimada) e `endpoint` (i.e. o valor final de amostras ou abund√¢ncia extrapolados) com o valor de abund√¢ncia = 8.

```{r}
resultados_rarefacao <- iNEXT(composicao_acaros, q = 0, 
                              datatype = "abundance", 
                              knots = 8, endpoint = 8)
```

Vamos criar um loop para facilitar a extra√ß√£o da riqueza rarefeita para as 70 comunidades.

```{r}
resultados_comunidades <- data.frame()
riqueza_rarefeita <- c()
for (i in 1:70){
resultados_comunidades <- data.frame(resultados_rarefacao$iNextEst[i])
riqueza_rarefeita[i] <- resultados_comunidades[8,4]
}
```

Vamos juntar esses resultados com os dados geogr√°ficos e ambientais.

```{r}
# Agrupando os dados em um dataframe final.
dados_combinado <- data.frame(riqueza_rarefeita, agua, coord)
```

Agora, seguindo os passos descritos no \@[cap8], vamos identificar o melhor modelo que representa a estrutura espacial dos dados da riqueza rarefeita.

```{r}
# Criando diferentes modelos usando a fun√ß√£o gls. 
# sem estrutura espacial
no_spat_gls <- gls(riqueza_rarefeita ~ agua, data = dados_combinado, 
                   method = "REML")

# Covari√¢ncia esf√©rica 
espher_model <- gls(riqueza_rarefeita ~ agua, data = dados_combinado, 
                    corSpher(form = ~lat + long, nugget = TRUE))

# Covari√¢ncia exponencial 
expon_model <- gls(riqueza_rarefeita ~ agua, data = dados_combinado, 
                   corExp(form = ~lat + long, nugget = TRUE))

# Covari√¢ncia Gaussiana 
gauss_model <- gls(riqueza_rarefeita ~ agua, data = dados_combinado, 
                   corGaus(form = ~lat + long, nugget = TRUE))

# Covari√¢ncia raz√£o quadr√°tica 
ratio_model <- gls(riqueza_rarefeita ~ agua, data = dados_combinado, 
                   corRatio(form = ~lat + long, nugget = TRUE))

```

Agora vamos usar o AIC para selecionar o modelo mais "prov√°vel" explicando a distribui√ß√£o da riqueza rarefeita das esp√©cies de √°caros.

```{r}
# Sele√ß√£o dos modelos.
aic_fit <- AIC(no_spat_gls, espher_model, expon_model, 
               gauss_model, ratio_model)

aic_fit %>% arrange(AIC)

# Visualizando os res√≠duos do modelo selecionado.
plot(gauss_model)
```

Percebam que os pontos est√£o dispersos no gr√°fico e n√£o apresentam padr√µes que indiquem heterogeneidade de vari√¢ncia.

```{r}
# Visualizando os resultados.
summary(gauss_model)$tTable 

# Calculando o R-squared.
rsquared(gauss_model)

# Obtendo os valores preditos pelo modelo.
predito <-  predict(gauss_model) 

# Plotando os resultados no gr√°fico. 
ggplot(data = dados_combinado, aes(x= agua, y= riqueza_rarefeita)) + 
  labs(x = "Concentra√ß√£o de √°gua no substrato", 
       y = "Riqueza rarefeita \ndas esp√©cies de √°caros", size = 15) +
  geom_point(size = 4, shape = 21, fill = "gray", alpha = 0.7) +
  tema_livro() +
  geom_line(aes(y = predito), size = 1)
```

**Interpreta√ß√£o dos resultados**

A concentra√ß√£o de √°gua no substrato explica 29,9% da varia√ß√£o na riqueza rarefeita das esp√©cies de √°caros. Como predito, a riqueza de esp√©cies de √°caros foi maior em comunidades localizadas em √°reas com substratos secos do que em √°reas com substratos √∫midos (t = -4.71, df = 68, P \< 0.01).

### Para se aprofundar

-   Recomendamos aos interessados que olhem a p√°gina do [EstimateS software](http://viceroy.eeb.uconn.edu/estimates) e baixem o manual do usu√°rio que cont√©m informa√ß√µes detalhadas sobre os √≠ndices de rarefa√ß√£o. Este site foi criado e √© mantido pelo Dr. Robert K. Colwell, um dos maiores especialistas do mundo em estimativas da biodiversidade

-   Recomendamos a p√°gina pessoal da pesquisadora [Anne Chao](http://chao.stat.nthu.edu.tw/wordpress/software_download/inext-online/) que √© uma das respons√°veis pelo desenvolvimento da metodologia e do pacote iNEXT. Nesta p√°gina, voc√™s ir√£o encontrar exemplos e explica√ß√µes detalhadas sobre as an√°lises.

-   Recomendamos tamb√©m o livro *Biological Diversity Frontiers in Measurement and Assessment* [@magurran_biological_2011].

### Refer√™ncias
